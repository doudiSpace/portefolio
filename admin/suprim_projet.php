<?php


// **********************************************************************************************************************************
// ******************************************************* model ********************************************************************
// **********************************************************************************************************************************

require_once('initAdmin.php');

// **********************************************************************************************************************************
// ***************************************************** controleur *****************************************************************
// **********************************************************************************************************************************

// ******************* vérification ID
if ($_SERVER['REQUEST_METHOD'] !== 'POST' || !isset($_POST['id']) || is_numeric($_POST['id'])===false){
  header('Location: admin.php');
  exit;
}
$id = htmlspecialchars($_POST['id']);

// ******************* récupération de la ligne ID

$ligneId = recuperationDbId('projets',$id);
$img = $ligneId[0]['img_mini'];

// ************************************************************************* SUPPRESSION

if (isset($_POST['suppression'])){

  // ------------- 1 suppression des images de la base de donné ET du dossier img/index-slide associées au projet
  $tab_img = recuperationDb('images');
  foreach ($tab_img as $i) {
    if ($i['id_projet'] == $id) {
      suppressionDb('images',$i['id']);
      unlink('../img/index-slide/'.$i['fichier']);
    }
  }
  // ------------- 2 suppression de la base de donné
  suppressionDb('projets',$id);

  // ------------- 3 suppression de l'image du dossier img/projets
  unlink('../img/projets/'.$img);

  // ------------- 4 redirection
  header('location:  admin.php');
  exit;

}

// *************************************************************************** FIN DE SUPPRESSION

// ******************* construction de la vue
$vue = [];
$vue['ligne'] = $id;
$vue['table'] = 'projets';
$vue['affichage'] = '<img src="../img/projets/'.$img.'">';
$vue['retour'] = 'admin.php';

// **********************************************************************************************************************************
// ***************************************************** vue ************************************************************************
// **********************************************************************************************************************************

require_once('vue/suprim.phtml');
